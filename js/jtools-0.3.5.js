/* Various tools for hiragana, katakana and kanji input: virtual keyboard, client-side kanji recognition. 2025-05-29 */
(()=>{window.sendRequest=function(e,t,n){var o=(()=>{for(var e=!1,t=0;t<a.length;t++){try{e=a[t]()}catch(e){continue}break}return e})();o&&(o.open(n?"POST":"GET",e,!0),n&&o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){4===o.readyState&&(200!==o.status&&304!==o.status?message("HTTP error. Something went wrong in server side.","error"):t(o.responseText))},4!==o.readyState)&&o.send(n)};var a=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}]})();var JTOOLS={};function onLoad(){var o=new Panels;JTOOLS.showLoader=function(){document.getElementById("footer").classList.add("loading")},JTOOLS.hideLoader=function(){document.getElementById("footer").classList.remove("loading")},JTOOLS.createPicker=o.createPicker,o.initPanel("kb",function(){JTOOLS.showLoader(),sendRequest("keyboard.html",function(e){var t=localStorage.getItem("kb.x"),n=localStorage.getItem("kb.y"),t=o.createPanel("kb",t?t+"px":"40px",n?n+"px":"40px");t.innerHTML=e,JTOOLS.keyboard=new Keyboard,t.style.display="block",JTOOLS.hideLoader()})}),o.initPanel("recog",function(){JTOOLS.showLoader(),sendRequest("recognition.html",function(e){var t=localStorage.getItem("recog.x"),n=localStorage.getItem("recog.y"),t=o.createPanel("recog",t?t+"px":"396px",n?n+"px":"248px");t.innerHTML=e,t.style.display="block",new Sliders,JTOOLS.recognition=new Recognition(null,function(e){JTOOLS.keyboard&&JTOOLS.keyboard.addSymbol(e)}),JTOOLS.handwriting=new Handwriting(JTOOLS.recognition.recognize),JTOOLS.hideLoader()})}),o.initPanel("kakijun",function(){JTOOLS.showLoader(),sendRequest("kakijun.html",function(e){var t=localStorage.getItem("kakijun.x"),n=localStorage.getItem("kakijun.y"),t=o.createPanel("kakijun",t?t+"px":"426px",n?n+"px":"258px");t.innerHTML=e,t.style.display="block",JTOOLS.hideLoader()})}),o.hasSavedPanes()||(o.loadPanel("kb"),o.loadPanel("recog"))}function message(e,t){var n=document.getElementById("message");n||((n=document.createElement("div")).setAttribute("id","message"),document.body.insertBefore(n,null)),n.innerHTML='<div class="'+(t=t||"info")+'">'+e+"</div>",n.style.display="block",n.onclick=function(){n.style.display="none"}}function ColorPicker(){this.showAtElement=function(e,t){var n,o,a,r=e.getBoundingClientRect(),i=r.left,e=e.offsetHeight+r.top,l=t,s=JTOOLS.createPicker("colorpicker",i,e);for(n=0;n<=100;n+=5)c(n/100,1,.75);for(s.appendChild(document.createElement("br")),n=0;n<=100;n+=5)c(n/100,1,.5);for(s.appendChild(document.createElement("br")),n=0;n<=100;n+=5)c(n/100,1,.25);for(s.appendChild(document.createElement("br")),o=0;o<=100;o+=5)c(0,0,o/100);return s.appendChild(document.createElement("br")),(i=document.createElement("button")).className="randomColor",i.innerHTML="Random color",i.onclick=function(){s.removePicker(),l("random")},s.appendChild(i),s;function c(e,t,n){var e=((e,t,n)=>{var o,a,r;return 0==t?o=a=r=n:(o=i(t=2*n-(n=n<.5?n*(1+t):n+t-n*t),n,e+1/3),a=i(t,n,e),r=i(t,n,e-1/3)),[Math.round(255*o),Math.round(255*a),Math.round(255*r)];function i(e,t,n){return n<0&&(n+=1),1<n&&--n,n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e}})(e,t,n),o="rgb("+e[0]+","+e[1]+","+e[2]+")";(a=document.createElement("button")).className="color",a.style.backgroundColor=o,a.onclick=function(){s.removePicker(),l(o)},s.appendChild(a)}}}window.addEventListener("load",onLoad),window.debug=document.getElementById("debug");var DRAG_TAGS_IGNORE=["textarea","button","canvas","input","rect"];function setDraggable(t){var n,o;function a(){localStorage.setItem(t.id+".x",t.getBoundingClientRect().left),localStorage.setItem(t.id+".y",t.getBoundingClientRect().top),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",a),document.body.classList.remove("unselectable")}function r(e){t.style.left=e.clientX-n+"px",t.style.top=e.clientY-o+"px"}t.addEventListener("mousedown",function(e){1!=e.which||-1<DRAG_TAGS_IGNORE.indexOf(e.target.tagName.toLowerCase())||e.target.classList.contains("no-drag")||(n=e.clientX-t.getBoundingClientRect().left,o=e.clientY-t.getBoundingClientRect().top,document.addEventListener("mousemove",r),document.addEventListener("mouseup",a),document.body.classList.add("unselectable"))})}function Handwriting(D){function t(){for(var e=[],t=3;1<=t;t--){for(var n=Math.pow(2,t),o=d/n,a=m/n,r="",i=1;i<n;i++){var l=Math.floor(o*i)+.5,s=Math.floor(a*i)+.5;r+="M"+l+" 0V"+m+"M0 "+s+"H"+d}var c=R(E,"path",!0).attrs({d:r,fill:"none",stroke:"#000","stroke-width":1,"stroke-opacity":1/(3*n)});e.push(c)}return e}function n(){x<0||i||(A[x].wipe(),--x,o(),r())}function o(){x<0?(M.classList.add("disabled"),B.classList.add("disabled")):(M.classList.remove("disabled"),B.classList.remove("disabled")),x<A.length-1?C.classList.remove("disabled"):C.classList.add("disabled")}function H(e){e&&(L="random"===e?(O.classList.add("randomColorIcon"),O.style.backgroundColor="transparent",h=!0,y()):(O.classList.remove("randomColorIcon"),O.style.backgroundColor=e,h=!1,e),w(),localStorage.setItem("hw.color",e))}function z(e){(!e||g.indexOf(e)<0)&&(e=g[0]);for(var t=/^bg-.*/,n=0;n<u.classList.length;n++)u.classList[n].match(t)&&u.classList.remove(u.classList[n]);"bg-none"!==e&&u.classList.add(e),F.className=e,localStorage.setItem("hw.bg",e)}function a(e,t){e=e.classList,t?e.contains("active")||e.add("active"):e.contains("active")&&e.remove("active")}function r(){D(X())}var i,e=localStorage.getItem("hw.grid"),l=localStorage.getItem("hw.calligraphy"),s=localStorage.getItem("hw.numbers"),c=localStorage.getItem("hw.color"),j=localStorage.getItem("hw.bg"),J=localStorage.getItem("hw.thickness"),W=localStorage.getItem("hw.smoothing"),u=document.getElementById("recogPaper"),d=u.clientWidth,m=u.clientHeight,g=["bg-none","bg-paper","bg-blackboard"],h=c&&"random"===c,V=!h&&c?c:"#444",f=!e||"true"===e,v="true"===s,p=!l||"true"===l,b=J?+J:10,k=W?+W:5,y=function(){return"rgb("+Math.floor(30+140*Math.random())+","+Math.floor(30+140*Math.random())+","+Math.floor(30+140*Math.random())+")"},w=function(){return(S=S||{"stroke-linecap":"round","stroke-linejoin":"round"}).fill=p?L:"none",S.stroke=L,S["stroke-width"]=p?b/2:b,S},X=function(){for(var e,t=Number.MAX_VALUE,n=Number.MAX_VALUE,o=Number.MIN_VALUE,a=Number.MIN_VALUE,r="",i=0;i<=x;i++)(e=A[i].dots)[0].x<t&&(t=e[0].x),e[0].y<n&&(n=e[0].y),e[0].x>o&&(o=e[0].x),e[0].y>a&&(a=e[0].y),e[e.length-1].x<t&&(t=e[e.length-1].x),e[e.length-1].y<n&&(n=e[e.length-1].y),e[e.length-1].x>o&&(o=e[e.length-1].x),e[e.length-1].y>a&&(a=e[e.length-1].y);t-o==0&&(t+=.01,o-=.01),n-a==0&&(n+=.01,a-=.01);var l,s,c,u,d,m=Math.abs(t-o),g=Math.abs(n-a);for(5*g<m?(n-=l=(m-g)/2,a+=l):5*m<g&&(t-=l=(g-m)/2,o+=l),i=0;i<=x;i++)s=255*((e=A[i].dots)[0].x-t)/(o-t),c=255*(e[0].y-n)/(a-n),u=255*(e[e.length-1].x-t)/(o-t),d=255*(e[e.length-1].y-n)/(a-n),r+=h(s)+h(c)+h(u)+h(d);return r;function h(e){e=(0^e).toString(16);return 1===e.length?"0"+e:e}},E=R(u,"svg",!1).attrs({width:d,height:m,version:"1.1",style:"overflow: hidden; position: relative;"}).child("desc","JTOOLS").child("defs"),I=f?t():[],L=h?y():V,S=w(),A=[],x=-1,N=R(E,"rect").attrs({width:d,height:m,fill:"#000",stroke:"none","fill-opacity":0,"stroke-width":0}),M=document.getElementById("btnUndo"),C=document.getElementById("btnRedo"),B=document.getElementById("btnClear"),e=document.getElementById("tglGrid"),s=document.getElementById("tglCalligraphy"),l=document.getElementById("tglNumbers"),O=document.getElementById("btnColor"),F=document.getElementById("btnBg"),T=document.getElementById("sldThickness"),P=document.getElementById("sldBrushMass");function U(e){return 0<("wheelDelta"in e?e.wheelDelta:-e.detail)?T.valueUp():T.valueDown(),e.preventDefault(),!1}function R(e,t,n){var o=document.createElementNS("http://www.w3.org/2000/svg",t);return n?e.insertBefore(o,e.firstChild):e.appendChild(o),o.attrs=function(e){for(var t in e)e.hasOwnProperty(t)&&o.setAttribute(t,e[t]);return o},o.child=function(e,t){e=document.createElementNS("http://www.w3.org/2000/svg",e);return t&&(e.innerHTML=t),o.appendChild(e),o},o.toFront=function(){return e.removeChild(o),e.appendChild(o),o},o.remove=function(){return o&&e.removeChild(o),o=null},o}function Q(o){var s,c,a=[o],u=o,d=null,r=null,m=[],g=(e=>{if(null==e||"object"!=typeof e)return e;var t,n=e.constructor();for(t in e)e.hasOwnProperty(t)&&(n[t]=e[t]);return n})(S),t=p?null:"M"+o.x+","+o.y+"L",e=null,i=null,h=p?R(E,"path").attrs(g):null,f=[],v=[],y=1,n={x:0,y:0};function l(){for(var e=m.length-1;0<=e;e--)m.pop().remove()}this.dots=a,this.addDot=function(e){d=u,u=(e=>(n.x+=(e.x-u.x)/k,n.y+=(e.y-u.y)/k,n.x*=.5,n.y*=.5,{x:u.x+n.x,y:u.y+n.y}))(e),a.push(u),(p?()=>{var e=d.x-d.y<u.x-u.y?1:-1,t=Math.atan2(u.y-d.y,u.x-d.x),t=(0===f.length&&(f.push({x:d.x-b*e/4,y:d.y-b*e/4}),v.push({x:d.x+b*e/4,y:d.y+b*e/4})),y=t>5*Math.PI/9||t<-Math.PI/9?.1<y?y-.05*y:y:t>Math.PI/9&&t<7*Math.PI/18?y<1.5?y+.05*y:y:y<1?y+.05*y:1<y?y-.05*y:1,f[f.length-1]),n=v[v.length-1],o={x:u.x-b*e*y/4,y:u.y-b*e*y/4},a={x:u.x+b*e*y/4,y:u.y+b*e*y/4},r=b/14,i=b/20,l=0===m.length?"C"+(n.x-r*e)+","+(n.y+i*e)+" "+(t.x-r*e)+","+(t.y+i*e)+" "+t.x+","+t.y+"z":" "+t.x+","+t.y+"z",t="M"+t.x+","+t.y+"L"+o.x+","+o.y+" "+a.x+","+a.y+" "+n.x+","+n.y+l;s="C"+(o.x+r*e)+","+(o.y-i*e)+" "+(a.x+r*e)+","+(a.y-i*e)+" "+a.x+","+a.y,0===m.length&&(c=l),h.attrs({d:"M"+o.x+","+o.y+s+"z"}),m.push(R(E,"path").attrs(g).attrs({d:t})),f.push(o),v.push(a)}:()=>{var e="M"+d.x+","+d.y+"L"+u.x+","+u.y;t+=u.x+","+u.y+" ",m.push(R(E,"path").attrs(g).attrs({d:e}))})()},this.validate=function(){return 2<a.length},this.draw=function(){t?e=R(E,"path").attrs(g).attrs({d:t}):((()=>{var e,t=f,n=v,o="M"+t[0].x+","+t[0].y+"L";for(e=0;e<t.length;e++)o+=t[e].x+","+t[e].y+" ";for(o+=s+"L",e=n.length-1;0<=e;e--)o+=n[e].x+","+n[e].y+" ";o+=c,i=R(E,"path").attrs(g).attrs({d:o})})(),h=h&&h.remove());l(),N.toFront()},this.drawNumber=function(e){var t=5<a.length?a[5]:a[a.length-1],t=Math.atan2(t.y-o.y,t.x-o.x),n=o.x-20*Math.cos(t),t=o.y-20*Math.sin(t);r=R(E,"text").attrs({x:n,y:t,stroke:"none",fill:g.stroke,"font-size":16,style:"text-anchor: middle; font: 16px Arial"}).child("tspan",e),N.toFront()},this.wipe=function(){h=h&&h.remove(),i=i&&i.remove(),e=e&&e.remove(),r=r&&r.remove(),l()},this.wipeNumber=function(){r=r&&r.remove()}}N.onmousedown=function(e){var t;if(1===e.which)return t=u.getBoundingClientRect(),i=new Q({x:e.clientX-t.left,y:e.clientY-t.top}),document.addEventListener("mousemove",n),document.addEventListener("mouseup",o),!1;function n(e){1===e.which&&i&&i.addDot({x:e.clientX-t.left,y:e.clientY-t.top})}function o(e){1===e.which&&i&&(i.validate()?(A[++x]=i,M.classList.remove("disabled"),B.classList.remove("disabled"),i.draw(),v&&i.drawNumber(x+1),h&&(L=y(),w()),x===A.length-1&&C.classList.add("disabled"),i=null,r()):(i.wipe(),i=null),a())}function a(){document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",o)}},T.setValue(b),T.onchange=function(){b=T.value,S=w(),localStorage.setItem("hw.thickness",b)},P.setValue(k),P.onchange=function(){k=P.value,localStorage.setItem("hw.smoothing",k)},M.onclick=n,C.onclick=function(){var e=A[x+1];e&&(x+=1,e.draw(),v)&&e.drawNumber(x+1),o(),r()},B.onclick=function(){for(var e=x;0<=e;e--)A[e].wipe();x=-1,o(),r()},e.onclick=function(){if(f)for(var e=I.length-1;0<=e;e--)I.pop().remove();else I=t();a(this,f=!f),localStorage.setItem("hw.grid",f)},s.onclick=function(){p=!p,S=w(),a(this,p),localStorage.setItem("hw.calligraphy",p)},l.onclick=function(){v=!v;for(var e=0;e<=x;e++)v?A[e].drawNumber(e+1):A[e].wipeNumber();a(this,v),localStorage.setItem("hw.numbers",v)},O.onclick=function(){(new ColorPicker).showAtElement(this,H)},F.onclick=function(){for(var e=this.getBoundingClientRect(),n=JTOOLS.createPicker("bgPicker",e.left,this.offsetHeight+e.top),t=0;t<g.length;t++)(e=>{var t=document.createElement("button");t.className="btn-bg "+e,t.onclick=function(){n.removePicker(),z(e)},n.appendChild(t)})(g[t])},a(e,f),a(s,p),a(l,v),H(c),z(j),u.addEventListener("contextmenu",function(e){return e.preventDefault(),n(),!1},!1),u.addEventListener("mousewheel",U,!1),u.addEventListener("DOMMouseScroll",U,!1)}function Keyboard(){var c,u,o,a,d={a:"あ",i:"い",u:"う",e:"え",o:"お",ka:"か",ki:"き",ku:"く",ke:"け",ko:"こ",sa:"さ",si:"し",su:"す",se:"せ",so:"そ",shi:"し",ta:"た",ti:"ち",tu:"つ",te:"て",to:"と",chi:"ち",tsu:"つ",na:"な",ni:"に",nu:"ぬ",ne:"ね",no:"の",ha:"は",hi:"ひ",hu:"ふ",he:"へ",ho:"ほ",fu:"ふ",ma:"ま",mi:"み",mu:"む",me:"め",mo:"も",ya:"や",yu:"ゆ",yo:"よ",ra:"ら",ri:"り",ru:"る",re:"れ",ro:"ろ",wa:"わ",wo:"を","n'":"ん",ga:"が",gi:"ぎ",gu:"ぐ",ge:"げ",go:"ご",za:"ざ",ji:"じ",zu:"ず",ze:"ぜ",zo:"ぞ",da:"だ",di:"ぢ",du:"づ",de:"で",do:"ど",ba:"ば",bi:"び",bu:"ぶ",be:"べ",bo:"ぼ",pa:"ぱ",pi:"ぴ",pu:"ぷ",pe:"ぺ",po:"ぽ",kya:"きゃ",kyu:"きゅ",kyo:"きょ",gya:"ぎゃ",gyu:"ぎゅ",gyo:"ぎょ",sya:"しゃ",syu:"しゅ",syo:"しょ",sha:"しゃ",shu:"しゅ",sho:"しょ",ja:"じゃ",ju:"じゅ",jo:"じょ",jya:"じゃ",jyu:"じゅ",jyo:"じょ",tya:"ちゃ",tyu:"ちゅ",tyo:"ちょ",cha:"ちゃ",chu:"ちゅ",cho:"ちょ",nya:"にゃ",nyu:"にゅ",nyo:"にょ",hya:"ひゃ",hyu:"ひゅ",hyo:"ひょ",bya:"びゃ",byu:"びゅ",byo:"びょ",pya:"ぴゃ",pyu:"ぴゅ",pyo:"ぴょ",mya:"みゃ",myu:"みゅ",myo:"みょ",rya:"りゃ",ryu:"りゅ",ryo:"りょ",kk:"っk",gg:"っg",ss:"っs",zz:"っz",tt:"っt",dd:"っd",hh:"っh",ff:"っf",bb:"っb",pp:"っp",fa:"ふぁ",fi:"ふぃ",fe:"ふぇ",fo:"ふぉ","а":"あ","и":"い","у":"う","э":"え","о":"お","е":"え","й":"い","ка":"か","ки":"き","ку":"く","кэ":"け","ко":"こ","ке":"け","са":"さ","си":"し","су":"す","сэ":"せ","со":"そ","се":"せ","та":"た","ти":"ち","цу":"つ","тэ":"て","то":"と","те":"て","на":"な","ни":"に","ну":"ぬ","нэ":"ね","но":"の","не":"ね","ха":"は","хи":"ひ","фу":"ふ","хэ":"へ","хо":"ほ","хе":"へ","ма":"ま","ми":"み","му":"む","мэ":"め","мо":"も","ме":"め","я":"や","ю":"ゆ","ё":"よ","ра":"ら","ри":"り","ру":"る","рэ":"れ","ро":"ろ","ре":"れ","ва":"わ","-ва":"は","во":"を","-о":"を","нъ":"ん","га":"が","ги":"ぎ","гу":"ぐ","гэ":"げ","го":"ご","ге":"げ","дза":"ざ","дзи":"じ","дзу":"ず","дзэ":"ぜ","дзо":"ぞ","дзе":"ぜ","за":"ざ","зи":"じ","зу":"ず","зэ":"ぜ","зо":"ぞ","зе":"ぜ","да":"だ","дэ":"で","до":"ど","де":"で","ба":"ば","би":"び","бу":"ぶ","бэ":"べ","бо":"ぼ","бе":"べ","па":"ぱ","пи":"ぴ","пу":"ぷ","пэ":"ぺ","по":"ぽ","пе":"ぺ","кя":"きゃ","кю":"きゅ","кё":"きょ","гя":"ぎゃ","гю":"ぎゅ","гё":"ぎょ","ся":"しゃ","сю":"しゅ","сё":"しょ","дзя":"じゃ","дзю":"じゅ","дзё":"じょ","зя":"じゃ","зю":"じゅ","зё":"じょ","тя":"ちゃ","тю":"ちゅ","тё":"ちょ","ня":"にゃ","ню":"にゅ","нё":"にょ","хя":"ひゃ","хю":"ひゅ","хё":"ひょ","бя":"びゃ","бю":"びゅ","бё":"びょ","пя":"ぴゃ","пю":"ぴゅ","пё":"ぴょ","мя":"みゃ","мю":"みゅ","мё":"みょ","ря":"りゃ","рю":"りゅ","рё":"りょ",":":"う","кк":"っк","гг":"っг","сс":"っс","тт":"っт","цц":"っц","дд":"っд","хх":"っх","фф":"っф","бб":"っб","пп":"っп","фа":"ふぁ","фи":"ふぃ","фэ":"ふぇ","фо":"ふぉ","фе":"ふぇ","--":"ー",_:"ー","~":"～"," ":"　",",":"、",".":"。","!":"！","?":"？","%":"％","[":"【","]":"】","\\":"＼","/":"／",0:"０",1:"１",2:"２",3:"３",4:"４",5:"５",6:"６",7:"７",8:"８",9:"９"},e=(this.addSymbol=y,document.getElementById("outHiragana").onclick=l,document.getElementById("outKatakana").onclick=s,document.getElementById("hiragana").onclick=h,document.getElementById("katakana").onclick=h,document.getElementById("romaji").onclick=h,document.getElementById("kiriji").onclick=h,document.getElementById("space").onclick=function(){y("　")},document.getElementById("backspace").onclick=function(){var e=u.selectionStart,t=u.selectionEnd;void 0!==e?e===t?0<e&&(u.value=u.value.slice(0,e-1)+u.value.slice(t),u.selectionEnd=u.selectionStart=e-1):(u.value=u.value.slice(0,e)+u.value.slice(t),u.selectionEnd=u.selectionStart=e):u.value=u.value.slice(0,-1);u.focus()},document.getElementById("clear").onclick=function(){u.value="",u.focus()},(u=document.getElementById("str")).oninput=function(){var e,t,n=u.selectionStart,o=u.value.charAt(n-3)&&u.value.charAt(n-3).toLowerCase(),a=u.value.charAt(n-2)&&u.value.charAt(n-2).toLowerCase(),r=u.value.charAt(n-1)&&u.value.charAt(n-1).toLowerCase(),o=d[o+a+r],i=d[a+r],l=d[r];o?(e=o,t=3):i?(e=i,t=2):l?(e=l,t=1,"n"!==a.toLowerCase()&&"н"!==a.toLowerCase()||s()):("n"===a.toLowerCase()&&"y"!==r.toLowerCase()||"н"===a.toLowerCase())&&s();e&&(u.value.charAt(n-1)!==r!==c&&(e=g(e,"hiragana","katakana")),n<=t?(u.value=e+u.value.slice(n),u.selectionStart=u.selectionEnd=e.length):(u.value=u.value.slice(0,n-t)+e+u.value.slice(n),u.selectionStart=u.selectionEnd=n-t+e.length));function s(){var e="ん";u.value.charAt(n-2)!==a!==c&&(e="ン"),u.value=u.value.slice(0,n-2)+e+u.value.slice(n-1),u.selectionStart=u.selectionEnd=n}},localStorage.getItem("kb.out.height")),t=(!e||0<navigator.userAgent.lastIndexOf("Chrome/")||(u.style.height=e),u.addEventListener("mousedown",function(){e=u.style.height}),document.addEventListener("mouseup",function(){u.style.height!==e&&localStorage.setItem("kb.out.height",u.style.height)}),u.focus(),localStorage.getItem("kb.out")),n=localStorage.getItem("kb.layout");function r(e){var t=document.getElementsByClassName("w-kanji");return 0<t.length&&(e.preventDefault(),o=(void 0===o?(a=0,n(),t[0]):((a=(a+=("wheelDelta"in e?e.wheelDelta:-e.detail)<0?1:-1)>=t.length?0:a)<0&&(a=t.length-1),n(),t[a])).innerHTML),!1;function n(){for(var e=0;e<t.length;e++)t[e].className="w-kanji"+(e===a?" selected":"")}}function i(){o=void 0,a=0}function l(){c=!1,document.getElementById("outHiragana").className="output selected",document.getElementById("outKatakana").className="output",m("katakana","hiragana"),u.focus(),localStorage.setItem("kb.out","outHiragana")}function s(){c=!0,document.getElementById("outKatakana").className="output selected",document.getElementById("outHiragana").className="output",m("hiragana","katakana"),u.focus(),localStorage.setItem("kb.out","outKatakana")}function m(e,t){var n,o,a=u.selectionStart,r=u.selectionEnd,i=u.value;void 0!==a&&a!==i.length&&(n=i.substring(0,a),o=i.substring(r,i.length),i=g(i.substring(a,r),e,t),u.value=n+i+o,u.selectionStart=a,u.selectionEnd=r)}function g(e,t,n){for(var o="",a=0;a<e.length;a++){var r=e.charAt(a),i=(e=>{var t;try{t=document.querySelector(e)}catch(e){}return t})("button["+t+"="+r+"].symb");o+=i?i.getAttribute(n):r}return o}function h(){var e=document.getElementsByClassName("symb"),t=e.length,n=document.getElementsByClassName("aux selected");if(n[0]){if(n[0]===this)return;n[0].className="aux"}("katakana"===this.id?s:l)(),this.className="aux selected";for(var o=0;o<t;o++)e[o].onclick||(e[o].onclick=v),e[o].innerHTML=e[o].getAttribute(this.id)||e[o].getAttribute("default");localStorage.setItem("kb.layout",this.id)}function f(e,t){return e.getAttribute(t)||e.getAttribute("default")}function v(e){y(e.shiftKey===c?f(this,"hiragana"):f(this,"katakana"))}function y(e){var t,n;e&&(t=u.selectionStart,n=u.selectionEnd,void 0!==t?(t===u.value.length?u.value+=e:u.value=u.value.slice(0,t)+e+u.value.slice(n),u.selectionEnd=u.selectionStart=t+e.length):u.value+=e,u.focus())}document.getElementById(n||"hiragana").onclick(),document.getElementById(t||"outHiragana").onclick(),document.addEventListener("mousedown",function(e){var t=document.getElementById("rikaichan-window")||document.getElementById("rikaichamp-window");if(t&&t.innerHTML&&(0===e.button||1===e.button)&&o)return e.preventDefault(),y(e.button?(e=>{for(var t,n=e.length-1;0<=n&&!((t=e.charCodeAt(n))<12353||12540<t);n--);return e.substr(0,n+1)})(o):o),i(),!1}),document.addEventListener("DOMMouseScroll",r,!1),document.addEventListener("mousewheel",r,!1),document.addEventListener("DOMNodeInserted",function(e){!o||"rikaichan-window"!==e.relatedNode.id&&"rikaichamp-window"!==e.relatedNode.id||i()}),document.addEventListener("DOMNodeRemoved",function(e){"rikaichan-window"!==e.relatedNode.id&&"rikaichamp-window"!==e.relatedNode.id||document.getElementById("str").focus()})}function Panels(){function i(e,t,n){var o=document.createElement("div");return o.style.display="none",o.id=e,o.className="panel animate-fade-in",o.style.left=t||"15%",o.style.top=n||"15%",r.appendChild(o),setDraggable(o),a.unshift(o),o.addEventListener("mousedown",function(){u(o)}),d(),o}function l(e){e&&(r.removeChild(e),a.splice(a.indexOf(e),1),localStorage.removeItem(e.id+".z"))}var a=[],o={},s=!1,r=document.getElementById("container");return{initPanel:function(a,r){o[a]=r,localStorage.getItem(a+".z")&&(c(a,r),s=!0);var e=document.getElementsByClassName("trigger-"+a),t=function(){var e=document.getElementById(a),e=!e||"none"===e.style.display;if(e)c(a,r);else{var e=a,t=document.getElementById(e),n=document.getElementsByClassName("trigger-"+e);if(t){for(var o=0;o<n.length;o++)n[o].classList.remove("on");t.classList.remove("animate-fade-in"),t.classList.add("animate-fade-out"),setTimeout(function(){t.style.display="none"},90)}localStorage.removeItem(e+".z")}};if(e.length)for(var n=0;n<e.length;n++)e[n].onclick=t},hasSavedPanes:function(){return s},loadPanel:function(e){o[e]&&o[e]()},createPanel:i,removePanel:l,createPicker:function(e,t,n){var o=i(e,t+"px",n+"px"),a=function(e){e.stopPropagation()};return o.addEventListener("mousedown",a),document.addEventListener("mousedown",r),o.removePicker=r,o.style.display="block",o;function r(){o.removeEventListener("mousedown",a),document.removeEventListener("mousedown",r),l(o),o=null}}};function c(e,t){var n=document.getElementById(e),o=document.getElementsByClassName("trigger-"+e);n?(n.style.display="block",n.classList.remove("animate-fade-out"),n.classList.add("animate-fade-in"),u(n)):t();for(var a=0;a<o.length;a++)o[a].classList.add("on")}function u(e){a.splice(a.indexOf(e),1),a.unshift(e),d()}function d(){for(var e=0;e<a.length;e++)a[e].style.zIndex=a.length-e,localStorage.setItem(a[e].id+".z",a[e].style.zIndex)}}function Recognition(i,o){var d={},m={N:[1,0],NE:[2,0],E:[2,1],SE:[2,2],S:[1,2],SW:[0,2],W:[0,1],NW:[0,0],MID:[1,1],isClose:function(e,t){return Math.abs(e[0]-t[0])<=1&&Math.abs(e[1]-t[1])<=1}},g={N:0,NE:1,E:2,SE:3,S:4,SW:5,W:6,NW:7,X:-1,isClose:function(e,t){return e===g.X||t===g.X||e===t||e===(t+1)%8||(e+1)%8===t}},r=51,l=77,h=1,f=.8,v=.6,y=.7,p=8,a=document.getElementById("output-strict"),e=document.getElementById("output-fuzzy"),t=document.getElementById("output-plus-minus-1"),n=document.getElementById("output-plus-minus-2"),e=(E(a),E(e),E(t),E(n),this.kanjis=d,localStorage.getItem("recog")),t=localStorage.getItem("recog_version");if(null!==e)if("0.3"!==t)s();else try{c(JSON.parse(e))}catch(e){s()}else s();function s(){sendRequest("data/recog-0.3.txt",function(e){localStorage.setItem("recog",e),localStorage.setItem("recog_version","0.3"),c(JSON.parse(e))})}function c(e){var t,n,o,a=0,r=Object.keys(e).length/20^0;for(t in e)e.hasOwnProperty(t)&&(n=new u(t,e[t]),(o=d[n.strokes.length])||(d[n.strokes.length]=o={}),o[n.symbol]=n,i&&a%r==0&&i(5*a/r^0),a++)}function u(e,t){var n,o=[],a=[],r=[],i=[],l=[];if(this.symbol=e,this.strokes=o,this.strokeStarts=a,this.strokeEnds=r,this.strokeDirections=i,this.moveDirections=l,t&&(t=t.replace(/x/g,"00").replace(/y/g,"ff")).length%8==0){var s=t.length/8;for(n=0;n<s;n++){m=t.substr(8*n,8);var c=parseInt(m.substr(0,2),16),u=parseInt(m.substr(2,2),16),d=parseInt(m.substr(4,2),16),m=parseInt(m.substr(6,2),16);o[n]=[c,u,d,m],a.push(b(c,u)),r.push(b(d,m)),i.push(k(c,u,d,m)),0<n&&l.push(k(o[n-1][2],o[n-1][3],c,u))}}}function b(e,t){return e<85?t<85?m.NW:t<170?m.W:m.SW:e<170?t<85?m.N:t<170?m.MID:m.S:t<85?m.NE:t<170?m.E:m.SE}function k(e,t,n,o){var a,n=n-e,e=o-t,o=Math.abs(n),t=Math.abs(e);return o<r&&t<r?g.X:t<o?(a=l*o>>8<t,0<n?a?e<0?g.NE:g.SE:g.E:a?e<0?g.NW:g.SW:g.W):(a=l*t>>8<o,0<e?a?n<0?g.SW:g.SE:g.S:a?n<0?g.NW:g.NE:g.N)}function w(e){var t,n,o,a=[],r=d[e.strokes.length],l=e.strokeStarts,s=e.strokeEnds,c=e.strokeDirections,u=e.moveDirections;for(t in r)r.hasOwnProperty(t)&&(n=(e=>{for(var t=e.strokeStarts,n=e.strokeEnds,o=e.strokeDirections,a=e.moveDirections,r=0,i=0;i<l.length;i++)c[i]===o[i]?r+=h:g.isClose(c[i],o[i])&&(r+=h*y),0<i&&(u[i-1]===a[i-1]?r+=f:g.isClose(u[i-1],a[i-1])&&(r+=f*y)),l[i]===t[i]?r+=v:m.isClose(l[i],t[i])&&(r+=v*y),s[i]===n[i]?r+=v:m.isClose(s[i],n[i])&&(r+=v*y);return e=l.length*(h+2*v)+(l.length-1)*f,100*r/e})(r[t]),o=r[t].symbol,a.push({symbol:o,score:n}));return a.sort(function(e,t){return e.score>t.score?-1:e.score<t.score?1:0}),a.slice(0,p)}function E(e){for(var t=0;t<p;t++){var n=document.createElement("div");n.classList.add("output-item"),n.classList.add("no-drag"),n.onclick=function(e){e.preventDefault(),o(this.innerHTML)},e.appendChild(n)}}this.recognize=function(e){for(var t=w(new u("?",e)),n=0;n<a.children.length;n++)a.children[n].innerHTML=t[n]?t[n].symbol:""}}function Sliders(){for(var e=document.querySelectorAll("input[type=slider]"),t=0;t<e.length;t++){var n=e[t],o=new a(n);n.setValue=o.setValue,n.valueUp=o.valueUp,n.valueDown=o.valueDown}function a(t){var e=t.id,r=document.createElement("div"),n=document.createElement("div"),e=(t.parentElement.insertBefore(r,t),r.appendChild(n),r.className="no-drag slit "+e+"-slit",n.className="no-drag knob "+e+"-knob",E(r)),o=E(n),i=I(e.width,140),l=(I(e.height,16),I(o.width,19)),a=I(o.height,16),s="none"!==e.backgroundImage?e.backgroundImage:"url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIwAAAAQAQMAAAD+qgVFAAAAAXNSR0IArs4c6QAAAAZQTFRFmZmZ5+fnAKzB3gAAABRJREFUGNNjYMAE9f/RwIORKoQJAL0q8lNkiT1EAAAAAElFTkSuQmCC)",c="none"!==o.backgroundImage?o.backgroundImage:"url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAAQBAMAAAAG6llRAAAAAXNSR0IArs4c6QAAABVQTFRFlJSU1tbe1tbWzs7W9/f3tbW1597nN/SE2wAAADFJREFUCNdjCIWBAIYQFyhwYAhJg4IAKjMFoQDIVIICIFNZyQiElIFMYyhAYQYwwAAAVWUuIsQq8ZQAAAAASUVORK5CYII=)",e="auto"!==e.cursor?e.cursor:"pointer",o=parseInt(o.fontSize),u=parseFloat(t.getAttribute("min")),d=parseFloat(t.getAttribute("max")),m=parseFloat(t.getAttribute("step")),g=parseInt(t.getAttribute("angle"))%360*Math.PI/180,h=parseInt(t.getAttribute("showvalue")),f=(i<=l&&(i=140,r.style.width=i+"px",l=19,n.style.width=l+"px"),this.setValue=b,this.valueUp=k,this.valueDown=w,isNaN(u)&&(u=0),(d=isNaN(d)?20:d)<u&&(d=u),isNaN(m)&&(m=1),d<m&&(m=d),isNaN(g)&&(g=0),(h=isNaN(h)?1:h)&&(0==o||o<a||isNaN(o))&&(o="10px"),L(["transform","MozTransform","WebkitTransform","msTransform","OTransform"])),v=L(["transformOrigin","MozTransformOrigin","WebkitTransformOrigin","msTransformOrigin","OTransformOrigin"]);function y(e){return document.removeEventListener("mousemove",p),document.removeEventListener("mouseup",y),!1}function p(e){e=e,t=r,n=Math.sin(g),o=Math.cos(g),a=o<0?t.getBoundingClientRect().right:t.getBoundingClientRect().left,t=n<0?t.getBoundingClientRect().bottom:t.getBoundingClientRect().top;var t,n,o,a=((e.clientX-a-l/2*(o<0?-1:1))*o+(e.clientY-t-l/2*(n<0?-1:1))*n)*(d-u)/(i-l)+u;return 0<m&&(a+=m/2<(o=a%m)?m-o:-o),b(a<u?u:d<a?d:a),!1}function b(e){d<e?e=d:e<u&&(e=u),n.style.left=(e-u)*(i-l)/(d-u)+"px",t.value=e,n.innerHTML=h?Math.round(e):"&nbsp;",t.onchange&&t.onchange()}function k(){b(+t.value+(0<m?m:1))}function w(){b(t.value-(0<m?m:1))}function E(e){return window.getComputedStyle?getComputedStyle(e,null):e.currentStyle}function I(e,t){e=parseInt(e);return e||t}function L(e){for(var t=document.documentElement,n=0;n<e.length;n++)if("string"==typeof t.style[e[n]])return e[n];return null}function S(e,t,n){void 0!==t&&(e.style[t]=n)}function A(e){return(0<("wheelDelta"in e?e.wheelDelta:-e.detail)?k:w)(),e.preventDefault(),!1}t.style.display="none",r.style.backgroundImage=s,r.style.display="inline-block",r.style.cursor=e,r.title=t.title,S(r,f,"rotate("+g+"rad)"),S(r,v,"50% 50%"),n.style.backgroundImage=c,n.style.position="relative",n.style.lineHeight=a+"px",n.style.textAlign="center",n.style.fontSize=o,t.defaultValue&&t.defaultValue>=u&&t.defaultValue<=d?b(t.defaultValue):b(u),r.addEventListener("mousewheel",A,!1),r.addEventListener("DOMMouseScroll",A,!1),r.onmousedown=function(e){return p(e),document.addEventListener("mousemove",p),document.addEventListener("mouseup",y),!1}}}