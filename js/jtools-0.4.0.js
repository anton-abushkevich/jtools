/* Various tools for hiragana, katakana and kanji input: virtual keyboard, client-side kanji recognition. 2025-06-04 */
(()=>{window.sendRequest=function(e,t,n){var o=(()=>{for(var e=!1,t=0;t<a.length;t++){try{e=a[t]()}catch(e){continue}break}return e})();o&&(o.open(n?"POST":"GET",e,!0),n&&o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){4===o.readyState&&(200!==o.status&&304!==o.status?message("HTTP error. Something went wrong in server side.","error"):t(o.responseText))},4!==o.readyState)&&o.send(n)};var a=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}]})();var JTOOLS={};function onLoad(){var o=new Panels,e=0;JTOOLS.showLoader=function(){e++,document.getElementById("footer").classList.add("loading")},JTOOLS.hideLoader=function(){0===--e&&document.getElementById("footer").classList.remove("loading")},JTOOLS.kanjiData=new KanjiData,JTOOLS.createPicker=o.createPicker,JTOOLS.sliders=new Sliders,JTOOLS.utils=new Utils,o.initPanel("kb",function(){JTOOLS.showLoader(),sendRequest("keyboard.html",function(e){var t=localStorage.getItem("kb.x"),n=localStorage.getItem("kb.y"),t=o.createPanel("kb",t?t+"px":"40px",n?n+"px":"40px");t.innerHTML=e,JTOOLS.keyboard=new Keyboard,t.style.display="block",JTOOLS.hideLoader()})}),o.initPanel("recog",function(){JTOOLS.showLoader(),sendRequest("recognition.html",function(e){var t=localStorage.getItem("recog.x"),n=localStorage.getItem("recog.y"),t=o.createPanel("recog",t?t+"px":"396px",n?n+"px":"248px");t.innerHTML=e,t.style.display="block",JTOOLS.sliders.initSlider("sldThickness"),JTOOLS.sliders.initSlider("sldBrushMass"),JTOOLS.recognition=new Recognition(null,function(e){JTOOLS.keyboard&&JTOOLS.keyboard.addSymbol(e)},function(e){JTOOLS.kakijun&&JTOOLS.kakijun.setSymbol(e)}),JTOOLS.handwriting=new Handwriting(JTOOLS.recognition.recognize),JTOOLS.hideLoader()})}),o.initPanel("kakijun",function(){JTOOLS.showLoader(),sendRequest("kakijun.html",function(e){var t=localStorage.getItem("kakijun.x"),n=localStorage.getItem("kakijun.y"),t=o.createPanel("kakijun",t?t+"px":"426px",n?n+"px":"258px");t.innerHTML=e,t.style.display="block",JTOOLS.sliders.initSlider("kakijunProgress"),JTOOLS.sliders.initSlider("kakijunThickness"),JTOOLS.sliders.initSlider("kakijunSpeed"),JTOOLS.kakijun=new Kakijun,JTOOLS.hideLoader()})}),o.hasSavedPanels()||(o.loadPanel("kb"),o.loadPanel("recog"))}function message(e,t){var n=document.getElementById("message");n||((n=document.createElement("div")).setAttribute("id","message"),document.body.insertBefore(n,null)),n.innerHTML='<div class="'+(t=t||"info")+'">'+e+"</div>",n.style.display="block",n.onclick=function(){n.style.display="none"}}function ColorPicker(){this.showAtElement=function(e,t){var n,o,a,r=e.getBoundingClientRect(),s=r.left,e=e.offsetHeight+r.top,i=t,l=JTOOLS.createPicker("colorpicker",s,e);for(n=0;n<=100;n+=5)c(n/100,1,.75);for(l.appendChild(document.createElement("br")),n=0;n<=100;n+=5)c(n/100,1,.5);for(l.appendChild(document.createElement("br")),n=0;n<=100;n+=5)c(n/100,1,.25);for(l.appendChild(document.createElement("br")),o=0;o<=100;o+=5)c(0,0,o/100);return l.appendChild(document.createElement("br")),(s=document.createElement("button")).className="randomColor",s.innerHTML="Random color",s.onclick=function(){l.removePicker(),i("random")},l.appendChild(s),l;function c(e,t,n){var e=((e,t,n)=>{var o,a,r;return 0==t?o=a=r=n:(o=s(t=2*n-(n=n<.5?n*(1+t):n+t-n*t),n,e+1/3),a=s(t,n,e),r=s(t,n,e-1/3)),[Math.round(255*o),Math.round(255*a),Math.round(255*r)];function s(e,t,n){return n<0&&(n+=1),1<n&&--n,n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e}})(e,t,n),o="rgb("+e[0]+","+e[1]+","+e[2]+")";(a=document.createElement("button")).className="color",a.style.backgroundColor=o,a.onclick=function(){l.removePicker(),i(o)},l.appendChild(a)}}}window.addEventListener("load",onLoad),window.debug=document.getElementById("debug");var LZString=(()=>{var p=String.fromCharCode;return{compress:function(e){return e?LZString._compress(e,16,function(e){return p(e)}):""},_compress:function(e,t,n){for(var o,a,r,s,i={},l={},c="",u=2,d=3,m=2,h=[],g=0,f=0,v=0;v<e.length;v+=1)if(r=e.charAt(v),Object.prototype.hasOwnProperty.call(i,r)||(i[r]=d++,l[r]=!0),s=c+r,Object.prototype.hasOwnProperty.call(i,s))c=s;else{if(Object.prototype.hasOwnProperty.call(l,c)){if(c.charCodeAt(0)<256){for(o=0;o<m;o++)g<<=1,f===t-1?(f=0,h.push(n(g)),g=0):f++;for(a=c.charCodeAt(0),o=0;o<8;o++)g=g<<1|1&a,f===t-1?(f=0,h.push(n(g)),g=0):f++,a>>=1}else{for(a=1,o=0;o<m;o++)g=g<<1|a,f===t-1?(f=0,h.push(n(g)),g=0):f++,a=0;for(a=c.charCodeAt(0),o=0;o<16;o++)g=g<<1|1&a,f===t-1?(f=0,h.push(n(g)),g=0):f++,a>>=1}0===--u&&(u=Math.pow(2,m),m++),delete l[c]}else for(a=i[c],o=0;o<m;o++)g=g<<1|1&a,f===t-1?(f=0,h.push(n(g)),g=0):f++,a>>=1;0===--u&&(u=Math.pow(2,m),m++),i[s]=d++,c=String(r)}if(""!==c){if(Object.prototype.hasOwnProperty.call(l,c)){if(c.charCodeAt(0)<256){for(o=0;o<m;o++)g<<=1,f===t-1?(f=0,h.push(n(g)),g=0):f++;for(a=c.charCodeAt(0),o=0;o<8;o++)g=g<<1|1&a,f===t-1?(f=0,h.push(n(g)),g=0):f++,a>>=1}else{for(a=1,o=0;o<m;o++)g=g<<1|a,f===t-1?(f=0,h.push(n(g)),g=0):f++,a=0;for(a=c.charCodeAt(0),o=0;o<16;o++)g=g<<1|1&a,f===t-1?(f=0,h.push(n(g)),g=0):f++,a>>=1}0===--u&&(u=Math.pow(2,m),m++),delete l[c]}else for(a=i[c],o=0;o<m;o++)g=g<<1|1&a,f===t-1?(f=0,h.push(n(g)),g=0):f++,a>>=1;0===--u&&m++}for(a=2,o=0;o<m;o++)g=g<<1|1&a,f===t-1?(f=0,h.push(n(g)),g=0):f++,a>>=1;for(;;){if(g<<=1,f===t-1){h.push(n(g));break}f++}return h.join("")},decompress:function(t){return t&&""!==t?LZString._decompress(t.length,32768,function(e){return t.charCodeAt(e)}):""},_decompress:function(e,t,n){for(var o,a,r,s,i,l,c=[],u=4,d=4,m=3,h="",g=[],f={val:n(0),position:t,index:1},v=0;v<3;v+=1)c[v]=v;for(a=0,s=Math.pow(2,2),i=1;i!==s;)r=f.val&f.position,f.position>>=1,0===f.position&&(f.position=t,f.val=n(f.index++)),a|=(0<r?1:0)*i,i<<=1;switch(a){case 0:for(a=0,s=Math.pow(2,8),i=1;i!==s;)r=f.val&f.position,f.position>>=1,0===f.position&&(f.position=t,f.val=n(f.index++)),a|=(0<r?1:0)*i,i<<=1;l=p(a);break;case 1:for(a=0,s=Math.pow(2,16),i=1;i!==s;)r=f.val&f.position,f.position>>=1,0===f.position&&(f.position=t,f.val=n(f.index++)),a|=(0<r?1:0)*i,i<<=1;l=p(a);break;case 2:return""}for(o=c[3]=l,g.push(l);;){if(e<f.index)return"";for(a=0,s=Math.pow(2,m),i=1;i!==s;)r=f.val&f.position,f.position>>=1,0===f.position&&(f.position=t,f.val=n(f.index++)),a|=(0<r?1:0)*i,i<<=1;switch(l=a){case 0:for(a=0,s=Math.pow(2,8),i=1;i!==s;)r=f.val&f.position,f.position>>=1,0===f.position&&(f.position=t,f.val=n(f.index++)),a|=(0<r?1:0)*i,i<<=1;c[d++]=p(a),l=d-1,u--;break;case 1:for(a=0,s=Math.pow(2,16),i=1;i!==s;)r=f.val&f.position,f.position>>=1,0===f.position&&(f.position=t,f.val=n(f.index++)),a|=(0<r?1:0)*i,i<<=1;c[d++]=p(a),l=d-1,u--;break;case 2:return g.join("")}if(0===u&&(u=Math.pow(2,m),m++),c[l])h=c[l];else{if(l!==d)return null;h=o+o.charAt(0)}g.push(h),c[d++]=o+h.charAt(0),o=h,0===--u&&(u=Math.pow(2,m),m++)}}}})(),DRAG_TAGS_IGNORE=["textarea","button","canvas","input","rect"];function setDraggable(t){var n,o;function a(){localStorage.setItem(t.id+".x",t.getBoundingClientRect().left),localStorage.setItem(t.id+".y",t.getBoundingClientRect().top),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",a),document.body.classList.remove("unselectable")}function r(e){t.style.left=e.clientX-n+"px",t.style.top=e.clientY-o+"px"}t.addEventListener("mousedown",function(e){1!=e.which||-1<DRAG_TAGS_IGNORE.indexOf(e.target.tagName.toLowerCase())||e.target.classList.contains("no-drag")||(n=e.clientX-t.getBoundingClientRect().left,o=e.clientY-t.getBoundingClientRect().top,document.addEventListener("mousemove",r),document.addEventListener("mouseup",a),document.body.classList.add("unselectable"))})}function Handwriting(J){function t(){x<0||s||(O[x].wipe(),--x,n(),r())}function n(){x<0?(C.classList.add("disabled"),N.classList.add("disabled")):(C.classList.remove("disabled"),N.classList.remove("disabled")),x<O.length-1?M.classList.remove("disabled"):M.classList.add("disabled")}function e(e){e&&(E="random"===e?(T.classList.add("randomColorIcon"),T.style.backgroundColor="transparent",h=!0,v()):(T.classList.remove("randomColorIcon"),T.style.backgroundColor=e,h=!1,e),p(),localStorage.setItem("hw.color",e))}function r(){J(K())}var s,o=localStorage.getItem("hw.grid"),a=localStorage.getItem("hw.calligraphy"),i=localStorage.getItem("hw.numbers"),l=localStorage.getItem("hw.color"),D=localStorage.getItem("hw.bg"),R=localStorage.getItem("hw.thickness"),V=localStorage.getItem("hw.smoothing"),c=document.getElementById("recogPaper"),u=c.clientWidth,d=c.clientHeight,y=JTOOLS.utils.svgElem,m=JTOOLS.utils.setActive,h=l&&"random"===l,l=!h&&l?l:"#444",g=!o||"true"===o,f="true"===i,k=!a||"true"===a,b=R?+R:10,L=V?+V:5,H=()=>JTOOLS.utils.drawGrid(w,u,d),z=e=>JTOOLS.utils.setBg(c,e,B,"hw.bg"),v=JTOOLS.utils.getRandomColor,p=function(){return(I=I||{"stroke-linecap":"round","stroke-linejoin":"round"}).fill=k?E:"none",I.stroke=E,I["stroke-width"]=k?b/2:b,I},K=function(){for(var e,t=[],n=0;n<=x;n++)e=O[n].dots,t.push([e[0].x,e[0].y,e[e.length-1].x,e[e.length-1].y]);return t},w=y(c,"svg").attrs({width:u,height:d,version:"1.1",style:"overflow: hidden; position: relative;"}).child("desc","JTOOLS").child("defs"),S=g?H():[],E=h?v():l,I=p(),O=[],x=-1,A=y(w,"rect").attrs({width:u,height:d,fill:"#000",stroke:"none","fill-opacity":0,"stroke-width":0}),C=document.getElementById("btnUndo"),M=document.getElementById("btnRedo"),N=document.getElementById("btnClear"),o=document.getElementById("tglGrid"),i=document.getElementById("tglCalligraphy"),a=document.getElementById("tglNumbers"),T=document.getElementById("btnColor"),B=document.getElementById("btnBg"),j=document.getElementById("sldThickness"),P=document.getElementById("sldBrushMass");function W(o){var l,c,a=[o],u=o,d=null,r=null,m=[],h=(e=>{if(null==e||"object"!=typeof e)return e;var t,n=e.constructor();for(t in e)e.hasOwnProperty(t)&&(n[t]=e[t]);return n})(I),t=k?null:"M"+o.x+","+o.y+"L",e=null,s=null,g=k?y(w,"path").attrs(h):null,f=[],v=[],p=1,n={x:0,y:0};function i(){for(var e=m.length-1;0<=e;e--)m.pop().remove()}this.dots=a,this.addDot=function(e){d=u,u=(e=>(n.x+=(e.x-u.x)/L,n.y+=(e.y-u.y)/L,n.x*=.5,n.y*=.5,{x:u.x+n.x,y:u.y+n.y}))(e),a.push(u),(k?()=>{var e=d.x-d.y<u.x-u.y?1:-1,t=Math.atan2(u.y-d.y,u.x-d.x),t=(0===f.length&&(f.push({x:d.x-b*e/4,y:d.y-b*e/4}),v.push({x:d.x+b*e/4,y:d.y+b*e/4})),p=t>5*Math.PI/9||t<-Math.PI/9?.1<p?p-.05*p:p:t>Math.PI/9&&t<7*Math.PI/18?p<1.5?p+.05*p:p:p<1?p+.05*p:1<p?p-.05*p:1,f[f.length-1]),n=v[v.length-1],o={x:u.x-b*e*p/4,y:u.y-b*e*p/4},a={x:u.x+b*e*p/4,y:u.y+b*e*p/4},r=b/14,s=b/20,i=0===m.length?"C"+(n.x-r*e)+","+(n.y+s*e)+" "+(t.x-r*e)+","+(t.y+s*e)+" "+t.x+","+t.y+"z":" "+t.x+","+t.y+"z",t="M"+t.x+","+t.y+"L"+o.x+","+o.y+" "+a.x+","+a.y+" "+n.x+","+n.y+i;l="C"+(o.x+r*e)+","+(o.y-s*e)+" "+(a.x+r*e)+","+(a.y-s*e)+" "+a.x+","+a.y,0===m.length&&(c=i),g.attrs({d:"M"+o.x+","+o.y+l+"z"}),m.push(y(w,"path").attrs(h).attrs({d:t})),f.push(o),v.push(a)}:()=>{var e="M"+d.x+","+d.y+"L"+u.x+","+u.y;t+=u.x+","+u.y+" ",m.push(y(w,"path").attrs(h).attrs({d:e}))})()},this.validate=function(){return 2<a.length},this.draw=function(){t?e=y(w,"path").attrs(h).attrs({d:t}):((()=>{var e,t=f,n=v,o="M"+t[0].x+","+t[0].y+"L";for(e=0;e<t.length;e++)o+=t[e].x+","+t[e].y+" ";for(o+=l+"L",e=n.length-1;0<=e;e--)o+=n[e].x+","+n[e].y+" ";o+=c,s=y(w,"path").attrs(h).attrs({d:o})})(),g=g&&g.remove());i(),A.toFront()},this.drawNumber=function(e){var t=5<a.length?a[5]:a[a.length-1],t=Math.atan2(t.y-o.y,t.x-o.x),n=o.x-20*Math.cos(t),t=o.y-20*Math.sin(t);r=y(w,"text").attrs({x:n,y:t,stroke:"none",fill:h.stroke,"font-size":16,style:"text-anchor: middle; font: 16px Arial"}).child("tspan",e),A.toFront()},this.wipe=function(){g=g&&g.remove(),s=s&&s.remove(),e=e&&e.remove(),r=r&&r.remove(),i()},this.wipeNumber=function(){r=r&&r.remove()}}A.onmousedown=function(e){var t;if(1===e.which)return t=c.getBoundingClientRect(),s=new W({x:e.clientX-t.left,y:e.clientY-t.top}),document.addEventListener("mousemove",n),document.addEventListener("mouseup",o),!1;function n(e){1===e.which&&s&&s.addDot({x:e.clientX-t.left,y:e.clientY-t.top})}function o(e){1===e.which&&s&&(s.validate()?(O[++x]=s,C.classList.remove("disabled"),N.classList.remove("disabled"),s.draw(),f&&s.drawNumber(x+1),h&&(E=v(),p()),x===O.length-1&&M.classList.add("disabled"),s=null,r()):(s.wipe(),s=null),a())}function a(){document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",o)}},j.setValue(b),j.onchange=function(){b=j.value,I=p(),localStorage.setItem("hw.thickness",b)},P.setValue(L),P.onchange=function(){L=P.value,localStorage.setItem("hw.smoothing",L)},C.onclick=t,M.onclick=function(){var e=O[x+1];e&&(x+=1,e.draw(),f)&&e.drawNumber(x+1),n(),r()},N.onclick=function(){for(var e=x;0<=e;e--)O[e].wipe();x=-1,n(),r()},o.onclick=function(){if(g)for(var e=S.length-1;0<=e;e--)S.pop().remove();else S=H();m(this,g=!g),localStorage.setItem("hw.grid",g)},i.onclick=function(){k=!k,I=p(),m(this,k),localStorage.setItem("hw.calligraphy",k)},a.onclick=function(){f=!f;for(var e=0;e<=x;e++)f?O[e].drawNumber(e+1):O[e].wipeNumber();m(this,f),localStorage.setItem("hw.numbers",f)},T.onclick=function(){(new ColorPicker).showAtElement(this,e)},B.onclick=()=>JTOOLS.utils.showBgPicker(B,z),m(o,g),m(i,k),m(a,f),h?T.classList.add("randomColorIcon"):e(l),z(D),c.addEventListener("contextmenu",function(e){return e.preventDefault(),t(),!1},!1),c.addEventListener("wheel",function(e){e.preventDefault();var t=0;t="wheelDelta"in e?e.wheelDelta:-e.detail;0<t?j.valueUp():j.valueDown();return!1})}function Kakijun(){let l=2.629;let t=document.getElementById("kakijunPaper"),e=t.clientWidth,n=t.clientHeight,c=JTOOLS.utils.svgElem,o=JTOOLS.utils.setActive,a=()=>JTOOLS.utils.drawGrid(d,e,n),u=JTOOLS.utils.getRandomColor,d=c(t,"svg",!1).attrs({width:e,height:n,version:"1.1",style:"overflow: hidden; position: relative;"}).child("desc","JTOOLS").child("defs"),m=20,h=16,r=document.getElementById("kakijunInput"),s=document.getElementById("kakijunProgress"),i=document.getElementById("kakijunThickness"),g=document.getElementById("kakijunSpeed"),f=document.getElementById("btnKakijunPlay"),v=document.getElementById("btnKakijunClear"),p=document.getElementById("tglKakijunGrid"),y=document.getElementById("tglKakijunNumbers"),k=document.getElementById("btnKakijunColor"),b=document.getElementById("btnKakijunBg"),L=[],w=localStorage.getItem("kj.grid"),J=localStorage.getItem("kj.numbers"),S=localStorage.getItem("kj.color"),D=localStorage.getItem("kj.bg"),R=localStorage.getItem("kj.thickness"),V=localStorage.getItem("kj.speed"),E=S&&"random"===S,I=E?u():S||"#555",O=!w||"true"===w,x="true"===J,H=e=>JTOOLS.utils.setBg(t,e,b,"kj.bg"),A=R?+R:4.5,C=V?+V:5,M=0,N=O?a():[],z={"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":A,fill:"none"},T;async function K(){B(),f.classList.add("disabled"),s.setDisabled(!0),L.forEach(e=>{e.path?.remove(),e.numberElem?.remove()}),L.length=0,M=0;let e=r.value,i=await JTOOLS.kanjiData.getKanjiPaths(e);i?(i.forEach((e,t)=>{E&&(I=u());var n,o,a,e=c(d,"path").attrs({d:e,transform:"scale("+l+")",stroke:I,...z}),r=Math.ceil(e.getTotalLength()),s=(e.style.strokeDasharray=r,1e3*(e.style.strokeDashoffset=r));L.push({type:"stroke",start:M,end:M+s,length:r,path:e,numberElem:(r=e,e=t+1,n=I,o=r.getPointAtLength(0),r=r.getPointAtLength(5),r=Math.atan2(r.y-o.y,r.x-o.x),a=o.x*l-m*Math.cos(r),o=o.y*l-m*Math.sin(r),c(d,"text").attrs({x:a,y:o,stroke:"none",fill:n,"font-size":h,style:"text-anchor: middle; font: "+h+"px Arial; display: none"}).child("tspan",e))}),M+=s;t<i.length-1&&(L.push({type:"delay",start:M,end:M+2e4}),M+=2e4)}),s.setMaxValue(M),f.classList.remove("disabled"),s.setDisabled(!1)):r.value=""}function B(){P(),j(0),s.setValue(0,!1),v.classList.add("disabled"),f.classList.remove("pause")}function j(o){L.forEach(e=>{var t,n;"stroke"===e.type&&(t=e.path,e.end<=o?(t.style.strokeDashoffset=0,x&&(e.numberElem.style.display="block")):o>=e.start?(n=(o-e.start)/(e.end-e.start),t.style.strokeDashoffset=e.length*(1-n),x&&o>e.start?e.numberElem.style.display="block":e.numberElem.style.display="none"):(t.style.strokeDashoffset=e.length,e.numberElem.style.display="none"))})}function W(){let a=performance.now();T=requestAnimationFrame(function e(t){var n=(t-a)*C*18;a=t;let o=parseInt(s.value)+n;o>=M&&(o=M),s.setValue(o,!1),j(o),o<M?T=requestAnimationFrame(e):(f.classList.remove("pause"),v.classList.remove("disabled"))})}function P(){T&&cancelAnimationFrame(T)}function X(n){n.preventDefault();let o=parseInt(s.value);n=Math.sign(n.deltaY);if(!(0===o&&-1===n||o===M&&1===n)){let e,t=o===M?L.length-1:L.findIndex(e=>o>=e.start&&o<e.end);if("delay"===L[t].type&&(t+=1),0<n&&t<L.length-1)e=L[t+2].start;else if(n<0&&o>L[t].start)e=L[t].start;else if(n<0&&0<t)e=L[t-2].start;else{if(!(0<n))return;e=L[t].end}s.setValue(e),j(e),P()}}return d.addEventListener("wheel",X),s.setScrollListener(X),s.setDisabled(!0),i.setValue(A),i.onchange=function(){A=i.value,z["stroke-width"]=A,L.forEach(e=>{"stroke"===e.type&&e.path.attrs({"stroke-width":A})}),localStorage.setItem("kj.thickness",A)},g.setValue(C),g.onchange=function(){C=g.value,localStorage.setItem("kj.speed",C)},o(p,O),p.addEventListener("click",function(){if(O)for(var e=N.length-1;0<=e;e--)N.pop().remove();else N=a();O=!O,o(this,O),localStorage.setItem("kj.grid",O)}),o(y,x),y.addEventListener("click",function(){x=!x,L.forEach(e=>{"stroke"===e.type&&(x&&parseInt(e.path.style.strokeDashoffset)!==e.length?e.numberElem.style.display="block":e.numberElem.style.display="none")}),o(this,x),localStorage.setItem("kj.numbers",x)}),E?k.classList.add("randomColorIcon"):k.style.backgroundColor=I,k.addEventListener("click",function(){(new ColorPicker).showAtElement(this,e=>{e&&("random"===e?(k.classList.add("randomColorIcon"),k.style.backgroundColor="transparent",E=!0):(k.classList.remove("randomColorIcon"),k.style.backgroundColor=e,E=!1,I=e),L.forEach(e=>{"stroke"===e.type&&(E&&(I=u()),e.path.attrs({stroke:I}),e.numberElem.attrs({fill:I}))}),localStorage.setItem("kj.color",e))})}),H(D),b.addEventListener("click",()=>JTOOLS.utils.showBgPicker(b,H)),s.onchange=function(){P();var e=parseInt(this.value);j(e),0===e?v.classList.add("disabled"):v.classList.remove("disabled"),f.classList.remove("pause")},r.addEventListener("input",K),f.addEventListener("click",function(){this.classList.contains("pause")?(P(),this.classList.remove("pause"),v.classList.remove("disabled")):0<s.value&&s.value<M?(W(),this.classList.add("pause"),v.classList.remove("disabled")):(B(),W(),v.classList.remove("disabled"),this.classList.add("pause"))}),v.addEventListener("click",function(){B()}),{setSymbol:function(e){e&&(r.value=e,K())}}}function KanjiData(){let e=localStorage.getItem("recog"),t=localStorage.getItem("recog_version"),n,o=!1,a=null;if(null!==e&&"0.4"===t)try{n=JSON.parse(LZString.decompress(e)),o=!0}catch(e){a=r()}else a=r();function r(){return new Promise(t=>{JTOOLS.showLoader(),sendRequest("data/recog-0.4.json",function(e){localStorage.setItem("recog",LZString.compress(e)),localStorage.setItem("recog_version","0.4"),n=JSON.parse(e),o=!0,t(n),JTOOLS.hideLoader()})})}return{getAllPathData:async function(){return o||await a,n},getKanjiPaths:async function(e){return o||await a,n[e]}}}function Keyboard(){var c,u,d={a:"あ",i:"い",u:"う",e:"え",o:"お",ka:"か",ki:"き",ku:"く",ke:"け",ko:"こ",sa:"さ",si:"し",su:"す",se:"せ",so:"そ",shi:"し",ta:"た",ti:"ち",tu:"つ",te:"て",to:"と",chi:"ち",tsu:"つ",na:"な",ni:"に",nu:"ぬ",ne:"ね",no:"の",ha:"は",hi:"ひ",hu:"ふ",he:"へ",ho:"ほ",fu:"ふ",ma:"ま",mi:"み",mu:"む",me:"め",mo:"も",ya:"や",yu:"ゆ",yo:"よ",ra:"ら",ri:"り",ru:"る",re:"れ",ro:"ろ",wa:"わ",wo:"を","n'":"ん",ga:"が",gi:"ぎ",gu:"ぐ",ge:"げ",go:"ご",za:"ざ",ji:"じ",zu:"ず",ze:"ぜ",zo:"ぞ",da:"だ",di:"ぢ",du:"づ",de:"で",do:"ど",ba:"ば",bi:"び",bu:"ぶ",be:"べ",bo:"ぼ",pa:"ぱ",pi:"ぴ",pu:"ぷ",pe:"ぺ",po:"ぽ",kya:"きゃ",kyu:"きゅ",kyo:"きょ",gya:"ぎゃ",gyu:"ぎゅ",gyo:"ぎょ",sya:"しゃ",syu:"しゅ",syo:"しょ",sha:"しゃ",shu:"しゅ",sho:"しょ",ja:"じゃ",ju:"じゅ",jo:"じょ",jya:"じゃ",jyu:"じゅ",jyo:"じょ",tya:"ちゃ",tyu:"ちゅ",tyo:"ちょ",cha:"ちゃ",chu:"ちゅ",cho:"ちょ",nya:"にゃ",nyu:"にゅ",nyo:"にょ",hya:"ひゃ",hyu:"ひゅ",hyo:"ひょ",bya:"びゃ",byu:"びゅ",byo:"びょ",pya:"ぴゃ",pyu:"ぴゅ",pyo:"ぴょ",mya:"みゃ",myu:"みゅ",myo:"みょ",rya:"りゃ",ryu:"りゅ",ryo:"りょ",kk:"っk",gg:"っg",ss:"っs",zz:"っz",tt:"っt",dd:"っd",hh:"っh",ff:"っf",bb:"っb",pp:"っp",fa:"ふぁ",fi:"ふぃ",fe:"ふぇ",fo:"ふぉ","а":"あ","и":"い","у":"う","э":"え","о":"お","е":"え","й":"い","ка":"か","ки":"き","ку":"く","кэ":"け","ко":"こ","ке":"け","са":"さ","си":"し","су":"す","сэ":"せ","со":"そ","се":"せ","та":"た","ти":"ち","цу":"つ","тэ":"て","то":"と","те":"て","на":"な","ни":"に","ну":"ぬ","нэ":"ね","но":"の","не":"ね","ха":"は","хи":"ひ","фу":"ふ","хэ":"へ","хо":"ほ","хе":"へ","ма":"ま","ми":"み","му":"む","мэ":"め","мо":"も","ме":"め","я":"や","ю":"ゆ","ё":"よ","ра":"ら","ри":"り","ру":"る","рэ":"れ","ро":"ろ","ре":"れ","ва":"わ","-ва":"は","во":"を","-о":"を","нъ":"ん","га":"が","ги":"ぎ","гу":"ぐ","гэ":"げ","го":"ご","ге":"げ","дза":"ざ","дзи":"じ","дзу":"ず","дзэ":"ぜ","дзо":"ぞ","дзе":"ぜ","за":"ざ","зи":"じ","зу":"ず","зэ":"ぜ","зо":"ぞ","зе":"ぜ","да":"だ","дэ":"で","до":"ど","де":"で","ба":"ば","би":"び","бу":"ぶ","бэ":"べ","бо":"ぼ","бе":"べ","па":"ぱ","пи":"ぴ","пу":"ぷ","пэ":"ぺ","по":"ぽ","пе":"ぺ","кя":"きゃ","кю":"きゅ","кё":"きょ","гя":"ぎゃ","гю":"ぎゅ","гё":"ぎょ","ся":"しゃ","сю":"しゅ","сё":"しょ","дзя":"じゃ","дзю":"じゅ","дзё":"じょ","зя":"じゃ","зю":"じゅ","зё":"じょ","тя":"ちゃ","тю":"ちゅ","тё":"ちょ","ня":"にゃ","ню":"にゅ","нё":"にょ","хя":"ひゃ","хю":"ひゅ","хё":"ひょ","бя":"びゃ","бю":"びゅ","бё":"びょ","пя":"ぴゃ","пю":"ぴゅ","пё":"ぴょ","мя":"みゃ","мю":"みゅ","мё":"みょ","ря":"りゃ","рю":"りゅ","рё":"りょ",":":"う","кк":"っк","гг":"っг","сс":"っс","тт":"っт","цц":"っц","дд":"っд","хх":"っх","фф":"っф","бб":"っб","пп":"っп","фа":"ふぁ","фи":"ふぃ","фэ":"ふぇ","фо":"ふぉ","фе":"ふぇ","--":"ー",_:"ー","~":"～"," ":"　",",":"、",".":"。","!":"！","?":"？","%":"％","[":"【","]":"】","\\":"＼","/":"／",0:"０",1:"１",2:"２",3:"３",4:"４",5:"５",6:"６",7:"７",8:"８",9:"９"},e=(this.addSymbol=g,document.getElementById("outHiragana").onclick=r,document.getElementById("outKatakana").onclick=s,document.getElementById("hiragana").onclick=i,document.getElementById("katakana").onclick=i,document.getElementById("romaji").onclick=i,document.getElementById("kiriji").onclick=i,document.getElementById("space").onclick=function(){g("　")},document.getElementById("backspace").onclick=function(){var e=u.selectionStart,t=u.selectionEnd;void 0!==e?e===t?0<e&&(u.value=u.value.slice(0,e-1)+u.value.slice(t),u.selectionEnd=u.selectionStart=e-1):(u.value=u.value.slice(0,e)+u.value.slice(t),u.selectionEnd=u.selectionStart=e):u.value=u.value.slice(0,-1);u.focus()},document.getElementById("clear").onclick=function(){u.value="",u.focus()},(u=document.getElementById("str")).oninput=function(){var e,t,n=u.selectionStart,o=u.value.charAt(n-3)&&u.value.charAt(n-3).toLowerCase(),a=u.value.charAt(n-2)&&u.value.charAt(n-2).toLowerCase(),r=u.value.charAt(n-1)&&u.value.charAt(n-1).toLowerCase(),o=d[o+a+r],s=d[a+r],i=d[r];o?(e=o,t=3):s?(e=s,t=2):i?(e=i,t=1,"n"!==a.toLowerCase()&&"н"!==a.toLowerCase()||l()):("n"===a.toLowerCase()&&"y"!==r.toLowerCase()||"н"===a.toLowerCase())&&l();e&&(u.value.charAt(n-1)!==r!==c&&(e=m(e,"hiragana","katakana")),n<=t?(u.value=e+u.value.slice(n),u.selectionStart=u.selectionEnd=e.length):(u.value=u.value.slice(0,n-t)+e+u.value.slice(n),u.selectionStart=u.selectionEnd=n-t+e.length));function l(){var e="ん";u.value.charAt(n-2)!==a!==c&&(e="ン"),u.value=u.value.slice(0,n-2)+e+u.value.slice(n-1),u.selectionStart=u.selectionEnd=n}},localStorage.getItem("kb.out.height")),t=(e&&(u.style.height=e),u.addEventListener("mousedown",function(){e=u.style.height}),document.addEventListener("mouseup",function(){u.style.height!==e&&localStorage.setItem("kb.out.height",u.style.height)}),u.focus(),localStorage.getItem("kb.out")),n=localStorage.getItem("kb.layout");function a(){var e=document.getElementById("tenten-ja-window")||document.getElementById("rikaichan-window");if(e&&e.shadowRoot)return e.shadowRoot}function r(){c=!1,document.getElementById("outHiragana").className="output selected",document.getElementById("outKatakana").className="output",o("katakana","hiragana"),u.focus(),localStorage.setItem("kb.out","outHiragana")}function s(){c=!0,document.getElementById("outKatakana").className="output selected",document.getElementById("outHiragana").className="output",o("hiragana","katakana"),u.focus(),localStorage.setItem("kb.out","outKatakana")}function o(e,t){var n,o,a=u.selectionStart,r=u.selectionEnd,s=u.value;void 0!==a&&a!==s.length&&(n=s.substring(0,a),o=s.substring(r,s.length),s=m(s.substring(a,r),e,t),u.value=n+s+o,u.selectionStart=a,u.selectionEnd=r)}function m(e,t,n){for(var o="",a=0;a<e.length;a++){var r=e.charAt(a),s=(e=>{var t;try{t=document.querySelector(e)}catch(e){}return t})("button["+t+"="+r+"].symb");o+=s?s.getAttribute(n):r}return o}function i(){var e=document.getElementsByClassName("symb"),t=e.length,n=document.getElementsByClassName("aux selected");if(n[0]){if(n[0]===this)return;n[0].className="aux"}("katakana"===this.id?s:r)(),this.className="aux selected";for(var o=0;o<t;o++)e[o].onclick||(e[o].onclick=h),e[o].innerHTML=e[o].getAttribute(this.id)||e[o].getAttribute("default");localStorage.setItem("kb.layout",this.id)}function l(e,t){return e.getAttribute(t)||e.getAttribute("default")}function h(e){g(e.shiftKey===c?l(this,"hiragana"):l(this,"katakana"))}function g(e){var t,n;e&&(t=u.selectionStart,n=u.selectionEnd,void 0!==t?(t===u.value.length?u.value+=e:u.value=u.value.slice(0,t)+e+u.value.slice(n),u.selectionEnd=u.selectionStart=t+e.length):u.value+=e,u.focus())}document.getElementById(n||"hiragana").onclick(),document.getElementById(t||"outHiragana").onclick(),document.addEventListener("mousedown",function(e){if(0===e.button||1===e.button){var t=a();if(!t)return;var n=t.querySelectorAll(".container");if(0<n.length&&n[0].classList.contains("hidden"))return;n=t.querySelectorAll(".jtools-selected");0<n.length&&g(e.button?n[0].innerText:(e=>{for(var t,n=e.length-1;0<=n&&!((t=e.charCodeAt(n))<12353||12540<t);n--);return e.substring(0,n+1)})(n[0].innerText))}return!1}),document.addEventListener("wheel",function(n){var e=a();if(e){let t=e.querySelectorAll(".w-kanji");if(0<t.length){let e=Array.from(t).findIndex(e=>e.classList.contains("jtools-selected"));(e+=Math.sign(n.deltaY))>=t.length?e=0:e<0&&(e=t.length-1);var o=e;for(let e=0;e<t.length;e++)e===o?(t[e].style="background-color: #EEE; color: #5C73B8",t[e].classList.add("jtools-selected")):(t[e].style="",t[e].classList.remove("jtools-selected"))}return!1}},!1),u.addEventListener("mousedown",e=>{1===e.button&&(e.preventDefault(),JTOOLS.kakijun)&&JTOOLS.kakijun.setSymbol(u.value.charAt(u.selectionStart))})}function Panels(){function s(e,t,n){var o=document.createElement("div");return o.style.display="none",o.id=e,o.className="panel animate-fade-in",o.style.left=t||"15%",o.style.top=n||"15%",r.appendChild(o),setDraggable(o),a.unshift(o),o.addEventListener("mousedown",function(){u(o)}),d(),o}function i(e){e&&(r.removeChild(e),a.splice(a.indexOf(e),1),localStorage.removeItem(e.id+".z"))}var a=[],o={},l=!1,r=document.getElementById("container");return{initPanel:function(a,r){o[a]=r,localStorage.getItem(a+".z")&&(c(a,r),l=!0);var e=document.getElementsByClassName("trigger-"+a),t=function(){var e=document.getElementById(a),e=!e||"none"===e.style.display;if(e)c(a,r);else{var e=a,t=document.getElementById(e),n=document.getElementsByClassName("trigger-"+e);if(t){for(var o=0;o<n.length;o++)n[o].classList.remove("on");t.classList.remove("animate-fade-in"),t.classList.add("animate-fade-out"),setTimeout(function(){t.style.display="none"},90)}localStorage.removeItem(e+".z")}};if(e.length)for(var n=0;n<e.length;n++)e[n].onclick=t},hasSavedPanels:function(){return l},loadPanel:function(e){o[e]&&o[e]()},createPanel:s,removePanel:i,createPicker:function(e,t,n){var o=s(e,t+"px",n+"px"),a=function(e){e.stopPropagation()};return o.addEventListener("mousedown",a),document.addEventListener("mousedown",r),o.removePicker=r,o.style.display="block",o;function r(){o.removeEventListener("mousedown",a),document.removeEventListener("mousedown",r),i(o),o=null}}};function c(e,t){var n=document.getElementById(e),o=document.getElementsByClassName("trigger-"+e);n?(n.style.display="block",n.classList.remove("animate-fade-out"),n.classList.add("animate-fade-in"),u(n)):t();for(var a=0;a<o.length;a++)o[a].classList.add("on")}function u(e){a.splice(a.indexOf(e),1),a.unshift(e),d()}function d(){for(var e=0;e<a.length;e++)a[e].style.zIndex=a.length-e,localStorage.setItem(a[e].id+".z",a[e].style.zIndex)}}function Recognition(i,o,a){var d={},l={},m={N:[1,0],NE:[2,0],E:[2,1],SE:[2,2],S:[1,2],SW:[0,2],W:[0,1],NW:[0,0],MID:[1,1],isClose:function(e,t){return Math.abs(e[0]-t[0])<=1&&Math.abs(e[1]-t[1])<=1}},h={N:0,NE:1,E:2,SE:3,S:4,SW:5,W:6,NW:7,X:-1,isClose:function(e,t){return e===h.X||t===h.X||e===t||e===(t+1)%8||(e+1)%8===t}},r=51,s=77,g=1,f=.8,v=.6,p=.7,y=8,c=document.getElementById("output-strict"),e=document.getElementById("output-fuzzy"),t=document.getElementById("output-plus-minus-1"),n=document.getElementById("output-plus-minus-2");function u(e,t,n){var o=[],a=[],r=[],s=[];this.symbol=e,this.strokes=t,this.paths=n,this.strokeStarts=o,this.strokeEnds=a,this.strokeDirections=r,this.moveDirections=s;for(var i=0;i<t.length;i++){var l=t[i];o.push(k(l[0],l[1])),a.push(k(l[2],l[3])),r.push(b(l[0],l[1],l[2],l[3])),0<i&&s.push(b(t[i-1][2],t[i-1][3],l[0],l[1]))}}function k(e,t){return e<85?t<85?m.NW:t<170?m.W:m.SW:e<170?t<85?m.N:t<170?m.MID:m.S:t<85?m.NE:t<170?m.E:m.SE}function b(e,t,n,o){var a,n=n-e,e=o-t,o=Math.abs(n),t=Math.abs(e);return o<r&&t<r?h.X:t<o?(a=s*o>>8<t,0<n?a?e<0?h.NE:h.SE:h.E:a?e<0?h.NW:h.SW:h.W):(a=s*t>>8<o,0<e?a?n<0?h.SW:h.SE:h.S:a?n<0?h.NW:h.NE:h.N)}function L(e){var t,n,o,a=[],r=d[e.strokes.length],i=e.strokeStarts,l=e.strokeEnds,c=e.strokeDirections,u=e.moveDirections;for(t in r)r.hasOwnProperty(t)&&(n=(e=>{for(var t=e.strokeStarts,n=e.strokeEnds,o=e.strokeDirections,a=e.moveDirections,r=0,s=0;s<i.length;s++)c[s]===o[s]?r+=g:h.isClose(c[s],o[s])&&(r+=g*p),0<s&&(u[s-1]===a[s-1]?r+=f:h.isClose(u[s-1],a[s-1])&&(r+=f*p)),i[s]===t[s]?r+=v:m.isClose(i[s],t[s])&&(r+=v*p),l[s]===n[s]?r+=v:m.isClose(l[s],n[s])&&(r+=v*p);return e=i.length*(g+2*v)+(i.length-1)*f,100*r/e})(r[t]),o=r[t].symbol,a.push({symbol:o,score:n}));return a.sort(function(e,t){return e.score>t.score?-1:e.score<t.score?1:0}),a.slice(0,y)}function w(e){for(var t=0;t<y;t++){var n=document.createElement("div");n.classList.add("output-item"),n.classList.add("no-drag"),n.onclick=function(e){e.preventDefault(),o(this.innerHTML)},n.onmouseup=function(e){1===e.button&&(e.preventDefault(),a(this.innerHTML))},e.appendChild(n)}}function S(e){for(var t,n=Number.MAX_VALUE,o=Number.MAX_VALUE,a=Number.MIN_VALUE,r=Number.MIN_VALUE,s=[],i=0;i<e.length;i++)(t=e[i])[0]<n&&(n=t[0]),t[1]<o&&(o=t[1]),a<t[0]&&(a=t[0]),r<t[1]&&(r=t[1]),t[2]<n&&(n=t[2]),t[3]<o&&(o=t[3]),a<t[2]&&(a=t[2]),r<t[3]&&(r=t[3]);n-a==0&&(n+=.01,a-=.01),o-r==0&&(o+=.01,r-=.01);var l,c,u=Math.abs(n-a),d=Math.abs(o-r);for(5*d<u?(o-=l=(u-d)/2,r+=l):5*u<d&&(n-=l=(d-u)/2,a+=l),i=0;i<e.length;i++)c=255*((t=e[i])[0]-n)/(a-n),s.push([c,255*(t[1]-o)/(r-o),255*(t[2]-n)/(a-n),255*(t[3]-o)/(r-o)]);return s}w(c),w(e),w(t),w(n),(async()=>{var o,a=await JTOOLS.kanjiData.getAllPathData();let r=0,s=Object.keys(a).length/20^0;for(o in a)if(a.hasOwnProperty(o)){let e=a[o],t=new u(o,S((e=>{for(var t=[],u=-1,d=-2,m=32,h=43,g=44,f=45,v=46,p=48,y=57,n=0;n<e.length;n++)t.push((t=>{var e,n,o,a,r=(e=>{var a=e;return{readLetter:function(){for(var e=0;;){if(e===a.length)return u;var t=a.charCodeAt(e);if(t!==m)return t===g||t===f||t===h||p<=t&&t<=y?d:(a=a.substring(e+1),t);e++}},readNumber:function(){for(var e,t,n=0;(t=a.charCodeAt(n))===g||t===m||t===h;)n++;for(e=n+1;;){if(e===a.length)break;if((t=a.charCodeAt(e))!==v&&(t<p||y<t))break;e++}var o=a.substring(n,e);return a=a.substring(e),Number(o)}}})(t),s=r.readLetter();if(77!==s&&109!==s)return c("Path must start with 'M' or 'm'");e=r.readNumber(),n=r.readNumber(),o=e,a=n;for(var i=-1;;){var l=r.readLetter();if(l===d){if(-1===i)return c("Expecting command, not number");l=i}else i=l;switch(l){case u:return[e,n,o,a];case 99:r.readNumber(),r.readNumber(),r.readNumber(),r.readNumber(),o+=r.readNumber(),a+=r.readNumber();break;case 67:r.readNumber(),r.readNumber(),r.readNumber(),r.readNumber(),o=r.readNumber(),a=r.readNumber();break;case 115:r.readNumber(),r.readNumber(),o+=r.readNumber(),a+=r.readNumber();break;case 83:r.readNumber(),r.readNumber(),o=r.readNumber(),a=r.readNumber();break;case 122:case 90:o=e,a=n;break;default:return c("Unexpected path command: "+l)}}function c(e){return console.log(e+". Invalid path: "+t),[0,0,0,0]}})(e[n]));return t})(e)),e),n=d[t.strokes.length];l[o]=e.length,n||(n={},d[t.strokes.length]=n),n[t.symbol]=t,i&&r%s==0&&i(5*r/s^0),r++}})(),this.recognize=function(e){for(var t=L(new u("?",S(e))),n=0;n<c.children.length;n++)c.children[n].innerHTML=t[n]?t[n].symbol:""},this.getKanji=function(e){var t=l[e];return t?d[t][e]:""}}function Sliders(){return{initSlider:e=>{var e=document.getElementById(e),t=new n(e);e.setMinValue=t.setMinValue,e.setMaxValue=t.setMaxValue,e.setValue=t.setValue,e.valueUp=t.valueUp,e.valueDown=t.valueDown,e.setScrollListener=t.setScrollListener,e.setDisabled=t.setDisabled}};function n(n){var e=n.id,r=document.createElement("div"),o=document.createElement("div"),e=(n.parentElement.insertBefore(r,n),r.appendChild(o),r.className="no-drag slit "+e+"-slit",o.className="no-drag knob "+e+"-knob",e=n,window.getComputedStyle?getComputedStyle(e,null):e.currentStyle),s=k(e.width,140),e=k(e.height,16),i=19,t=parseInt(n.fontSize),l=parseFloat(n.getAttribute("min")),c=parseFloat(n.getAttribute("max")),u=parseFloat(n.getAttribute("step")),d=parseInt(n.getAttribute("angle"))%360*Math.PI/180,a=parseInt(n.getAttribute("showvalue")),m=(this.setValue=v,this.setMinValue=function(e){l=e},this.setMaxValue=function(e){c=e},this.valueUp=p,this.valueDown=y,this.setScrollListener=function(e){r.removeEventListener("wheel",w,!1),r.addEventListener("wheel",e,!1)},this.setDisabled=function(e){e?r.classList.add("disabled"):r.classList.remove("disabled")},isNaN(l)&&(l=0),(c=isNaN(c)?20:c)<l&&(c=l),isNaN(u)&&(u=1),c<u&&(u=c),isNaN(d)&&(d=0),(a=isNaN(a)?1:a)&&(0===t||isNaN(t))&&(t="10px"),b(["transform","MozTransform","WebkitTransform","msTransform","OTransform"])),h=b(["transformOrigin","MozTransformOrigin","WebkitTransformOrigin","msTransformOrigin","OTransformOrigin"]);function g(e){return document.removeEventListener("mousemove",f),document.removeEventListener("mouseup",g),!1}function f(e){e=e,t=r,n=Math.sin(d),o=Math.cos(d),a=o<0?t.getBoundingClientRect().right:t.getBoundingClientRect().left,t=n<0?t.getBoundingClientRect().bottom:t.getBoundingClientRect().top;var t,n,o,a=((e.clientX-a-i/2*(o<0?-1:1))*o+(e.clientY-t-i/2*(n<0?-1:1))*n)*(c-l)/(s-i)+l;return 0<u&&(a+=u/2<(o=a%u)?u-o:-o),v(a<l?l:c<a?c:a),!1}function v(e,t=!0){c<e?e=c:e<l&&(e=l),o.style.left=(e-l)*(s-i)/(c-l)+"px",n.value=e,o.innerHTML=a?Math.round(e):"&nbsp;",t&&n.onchange&&n.onchange()}function p(){v(+n.value+(0<u?u:1))}function y(){v(n.value-(0<u?u:1))}function k(e,t){e=parseInt(e);return e||t}function b(e){for(var t=document.documentElement,n=0;n<e.length;n++)if("string"==typeof t.style[e[n]])return e[n];return null}function L(e,t,n){void 0!==t&&(e.style[t]=n)}function w(e){e.preventDefault();return(0<("wheelDelta"in e?e.wheelDelta:-e.detail)?p:y)(),!1}n.style.display="none",r.style.width=s+"px",r.style.height=e+"px",r.style.backgroundColor="#f1f1f1",r.style.boxShadow="inset 0 0 0 1px #ccc",r.style.display="inline-block",r.style.cursor="pointer",r.title=n.title,L(r,m,"rotate("+d+"rad)"),L(r,h,"50% 50%"),o.style.backgroundImage="url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAAQBAMAAAAG6llRAAAAAXNSR0IArs4c6QAAABVQTFRFlJSU1tbe1tbWzs7W9/f3tbW1597nN/SE2wAAADFJREFUCNdjCIWBAIYQFyhwYAhJg4IAKjMFoQDIVIICIFNZyQiElIFMYyhAYQYwwAAAVWUuIsQq8ZQAAAAASUVORK5CYII=)",o.style.width=i+"px",o.style.position="relative",o.style.lineHeight="16px",o.style.textAlign="center",o.style.fontSize=t,n.defaultValue&&n.defaultValue>=l&&n.defaultValue<=c?v(n.defaultValue):v(l),r.addEventListener("wheel",w,!1),r.onmousedown=function(e){if(!r.classList.contains("disabled"))return f(e),document.addEventListener("mousemove",f),document.addEventListener("mouseup",g),!1}}}function Utils(){let f=(e,t,n)=>{let o=document.createElementNS("http://www.w3.org/2000/svg",t);return n?e.insertBefore(o,e.firstChild):e.appendChild(o),o.attrs=function(e){for(var t in e)e.hasOwnProperty(t)&&o.setAttribute(t,e[t]);return o},o.child=function(e,t){e=document.createElementNS("http://www.w3.org/2000/svg",e);return t&&(e.innerHTML=t),o.appendChild(e),o},o.toFront=function(){return e.removeChild(o),e.appendChild(o),o},o.remove=function(){return o&&e.removeChild(o),o=null},o};let s=["bg-none","bg-paper","bg-blackboard"];return{drawGrid:(n,o,a,t,e,r)=>{var s=e||"#000",i=r||3,l=[];for(let e=t||3;1<=e;e--){var c=Math.pow(2,e),u=o/c,d=a/c;let t="";for(let e=1;e<c;e++){var m=Math.floor(u*e)+.5,h=Math.floor(d*e)+.5;t+="M"+m+" 0V"+a+"M0 "+h+"H"+o}var g=f(n,"path",!0).attrs({d:t,fill:"none",stroke:s,"stroke-width":1,"stroke-opacity":1/(c*i)});l.push(g)}return l},svgElem:f,setActive:(e,t)=>{e=e.classList;t?e.contains("active")||e.add("active"):e.contains("active")&&e.remove("active")},getRandomColor:()=>"rgb("+Math.floor(30+140*Math.random())+","+Math.floor(30+140*Math.random())+","+Math.floor(30+140*Math.random())+")",backgrounds:s,showBgPicker:function(e,n){for(var t=e.getBoundingClientRect(),o=JTOOLS.createPicker("bgPicker",t.left,e.offsetHeight+t.top),a=0;a<s.length;a++)(e=>{var t=document.createElement("button");t.className="btn-bg "+e,t.onclick=function(){o.removePicker(),n(e)},o.appendChild(t)})(s[a])},setBg:function(e,t,n,o){(!t||s.indexOf(t)<0)&&(t=s[0]);for(var a=/^bg-.*/,r=0;r<e.classList.length;r++)e.classList[r].match(a)&&e.classList.remove(e.classList[r]);"bg-none"!==t&&e.classList.add(t),n.className=t,localStorage.setItem(o,t)}}}